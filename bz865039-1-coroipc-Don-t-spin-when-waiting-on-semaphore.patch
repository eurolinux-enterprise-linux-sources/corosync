From 7ce8718a71b7afe341d9f9ac21c6724d6f18dfc4 Mon Sep 17 00:00:00 2001
From: Jan Friesse <jfriesse@redhat.com>
Date: Thu, 6 Dec 2012 10:44:55 +0100
Subject: [PATCH] coroipc: Don't spin when waiting on semaphore

Set timeout correctly before each call of sem_timedwait.

Signed-off-by: Jan Friesse <jfriesse@redhat.com>
Reviewed-by: Fabio M. Di Nitto <fdinitto@redhat.com>
---
 include/corosync/coroipc_ipc.h |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/include/corosync/coroipc_ipc.h b/include/corosync/coroipc_ipc.h
index f04134d..ebba342 100644
--- a/include/corosync/coroipc_ipc.h
+++ b/include/corosync/coroipc_ipc.h
@@ -218,10 +218,10 @@ retry_sem_wait:
 			return (CS_ERR_LIBRARY);
 		}
 
+retry_sem_timedwait:
 		timeout.tv_sec = time(NULL) + IPC_SEMWAIT_TIMEOUT;
 		timeout.tv_nsec = 0;
 
-retry_sem_timedwait:
 		res = sem_timedwait (sem, &timeout);
 		if (res == -1 && errno == ETIMEDOUT) {
 			pfd.fd = fd;
-- 
1.7.1

