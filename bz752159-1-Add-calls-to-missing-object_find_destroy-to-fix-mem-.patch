From 9ddb845f412531b6a2761f42823b6be43216a9c8 Mon Sep 17 00:00:00 2001
From: Angus Salkeld <asalkeld@redhat.com>
Date: Fri, 11 Nov 2011 08:08:22 +1100
Subject: [PATCH] Add calls to missing object_find_destroy() to fix mem leaks

Signed-off-by: Angus Salkeld <asalkeld@redhat.com>
Reviewed-by: Steven Dake <sdake@redhat.com>
---
 exec/main.c              |    6 ++++++
 exec/service.c           |    6 ++++--
 exec/totemconfig.c       |    1 +
 services/votequorum.c    |    1 +
 tools/corosync-notifyd.c |    1 +
 5 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/exec/main.c b/exec/main.c
index 31d2411..dd0ff99 100644
--- a/exec/main.c
+++ b/exec/main.c
@@ -395,6 +395,7 @@ static void member_object_joined (unsigned int nodeid)
 			"joined", strlen("joined"),
 			OBJDB_VALUETYPE_STRING);
 	}
+	objdb->object_find_destroy (object_find_handle);
 }
 
 static void member_object_left (unsigned int nodeid)
@@ -418,6 +419,7 @@ static void member_object_left (unsigned int nodeid)
 			"status", strlen("status"),
 			"left", strlen("left"));
 	}
+	objdb->object_find_destroy (object_find_handle);
 }
 
 static void confchg_fn (
@@ -816,6 +818,8 @@ static void corosync_totem_stats_init (void)
 			sizeof (zero_32), OBJDB_VALUETYPE_UINT32);
 
 	}
+	objdb->object_find_destroy (object_find_handle);
+
 	/* start stats timer */
 	api->timer_add_duration (1500 * MILLI_2_NANO_SECONDS, NULL,
 		corosync_totem_stats_updater,
@@ -1336,6 +1340,7 @@ static void corosync_fplay_control_init (void)
 			&object_runtime_handle) != 0) {
 		return;
 	}
+	objdb->object_find_destroy (object_find_handle);
 
 	objdb->object_create (object_runtime_handle,
 		&object_blackbox_handle,
@@ -1368,6 +1373,7 @@ static void corosync_stats_init (void)
 			&object_runtime_handle) != 0) {
 		return;
 	}
+	objdb->object_find_destroy (object_find_handle);
 
 	/* Connection objects */
 	objdb->object_create (object_runtime_handle,
diff --git a/exec/service.c b/exec/service.c
index be55459..5bc2a98 100644
--- a/exec/service.c
+++ b/exec/service.c
@@ -497,9 +497,11 @@ unsigned int corosync_service_defaults_link_and_init (struct corosync_api_v1 *co
 			&object_runtime_handle) == 0) {
 
 		corosync_api->object_create (object_runtime_handle,
-									 &object_stats_services_handle,
-									 "services", strlen ("services"));
+			&object_stats_services_handle,
+			"services", strlen ("services"));
 	}
+	corosync_api->object_find_destroy (object_find2_handle);
+
 	corosync_api->object_create (OBJECT_PARENT_HANDLE,
 		&object_internal_configuration_handle,
 		"internal_configuration",
diff --git a/exec/totemconfig.c b/exec/totemconfig.c
index a475bb3..8de3243 100644
--- a/exec/totemconfig.c
+++ b/exec/totemconfig.c
@@ -421,6 +421,7 @@ printf ("couldn't find totem handle\n");
 		}
 		totem_config->interfaces[ringnumber].member_count = member_count;
 		totem_config->interface_count++;
+		objdb->object_find_destroy (object_find_member_handle);
 	}
 
 	objdb->object_find_destroy (object_find_interface_handle);
diff --git a/services/votequorum.c b/services/votequorum.c
index 291da4b..adc31ce 100644
--- a/services/votequorum.c
+++ b/services/votequorum.c
@@ -1650,6 +1650,7 @@ static void votequorum_objdb_reload_notify(
 		else {
 			log_printf(LOGSYS_LEVEL_ERROR, "votequorum objdb tracking stopped, cannot find quorum{} handle in objdb\n");
 		}
+		corosync_api->object_find_destroy(find_handle);
 	}
 }
 
diff --git a/tools/corosync-notifyd.c b/tools/corosync-notifyd.c
index 7b00aa6..dd7f5d1 100644
--- a/tools/corosync-notifyd.c
+++ b/tools/corosync-notifyd.c
@@ -346,6 +346,7 @@ _cs_confdb_find_object (confdb_handle_t handle,
 		if (res != CS_OK) {
 			return res;
 		}
+		confdb_object_find_destroy(handle, parent_object_handle);
 
 		parent_object_handle = obj_handle;
 		obj_name_pt = strtok_r (NULL, SEPERATOR_STR, &save_pt);
-- 
1.7.1

